{% extends "home/base.html" %}

{% block title %}Edit Quotation - PFS Manager{% endblock %}

{% load static %}
{% block styles %}
<link rel="stylesheet" href="{% static 'plugins/select2/css/select2.min.css' %}" />
{% endblock %}

{% block navbar %}
{% include 'home/navbar.html' with navbar_tab='shop' %}
{% endblock %}

{% block content %}
<a href="{% url 'shop:quotes' %}" class="btn btn-link mb-4">Back to Quotations list</a>
<div class="card mb-4">
    <div class="card-header">
        Quotation Info
    </div>
    <div class="card-body">
        <div class="form-group row">
            <div class="col-md-4">
                <select id="form-product-search" class="form-control"
                    data-placeholder="Search products" style="width: 100%">
                </select>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'plugins/select2/js/select2.min.js' %}"></script>
<script type="text/javascript">
    var products = [];
    var cart = [];

    $(function() {

        $('#form-product-search').select2({
            ajax: {
                url: '{% url 'products:json' %}',
                delay: 500,
                dataType: 'json',
                type: 'get',
                data: function (params) {
                    return {
                        category: $('#form-product-search-category').val(),
                        name: params.term,
                        limit: 10,
                        page: params.page || 1
                    };
                },
                processResults: function (data, params) {
                    params.page = params.page || 1;
                    return {
                        results: $.map(data.products, function (product) {
                            if (product)
                                products[product.id] = product;
                            return {
                                id: product.id,
                                text: '[' + product.code + '] ' + product.name
                            };
                        }),
                        pagination: {
                            more: (params.page * 10) < data.products.length
                        }
                    };
                }
            },
            minimumInputLength: 1
        });

        $('#form-product-search').on('change', function() {
            id = $(this).val();
            quantity = 0;
            if (id > 0) {
                if (cart[id]) quantity = cart[id].quantity;
                cart[id] = {'id': id, 'quantity': quantity+1 }
            }
            else return;
            $.each(cart, function(key, item) {
                console.log(item);
            });
            $('#form-product-search').val(null).trigger('change');
        });

    });
</script>
{% endblock %}
